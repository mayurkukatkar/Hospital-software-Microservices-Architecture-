name: Deployment Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Build Backend Services
        run: ./mvnw clean install -DskipTests

      # Optional: Run Tests
      # - name: Run Tests
      #   run: ./mvnw test

  build-docker-images:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Build JARs
        run: ./mvnw clean package -DskipTests

      # Example for one service - repeated for all or use a matrix strategy
      # Ideally, you push to a registry (Docker Hub / GHCR / DigitalOcean Container Registry)

      # - name: Log in to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}

      # - name: Build and Push Discovery Server
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: backend/discovery-server
      #     push: true
      #     tags: ${{ secrets.DOCKER_USERNAME }}/raksha-discovery:latest

      # ... repeat for all services ...

  deploy:
    needs: build-docker-images
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            # Pull latest code
            cd /opt/raksha-hms
            git pull origin main

            # Rebuild images locally on the droplet (Simple Strategy)
            # OR pull from registry if you used the previous job to push
            ./mvnw clean package -DskipTests -f backend/pom.xml

            # Restart Services
            docker-compose -f docker-compose.app.yml up -d --build
